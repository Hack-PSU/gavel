{% extends "layout.html" %}
{% block title %}Vote{% endblock %}
{% block content %}
<div class="item">
  <div class="banner-tight" id="previous-header">
    <h1>Previous</h1>
  </div>
  <div id="previous-body">
    {% with item=prev %}
    {% include "_item.html" %}
    {% endwith %}
  </div>
</div>
<div class="item">
  <div class="banner-tight" id="current-header">
    <h1>Current</h1>
  </div>
  <div id="current-body">
    {% with item=next %}
    {% include "_item.html" %}
    {% endwith %}
  </div>
</div>

<div class="item">
  <div class="banner" id="vote-header">
    <h1>Vote</h1>
  </div>

  <div class="info">
    {% include "timer.html" %}
    <form action="{{ url_for('vote') }}" method="post">
      <p class="center">Which one is better?</p>
      {% include "info.html" %}
      <div id="vote-previous" class="radio-button button-left">
        <input type="radio" name="action" id="vote-previous-radio" value="Previous">
        <label for="vote-previous-radio">Previous</label>
      </div>

      <div id="vote-current" class="radio-button button-right">
        <input type="radio" name="action" id="vote-current-radio" value="Current">
        <label for="vote-current-radio">Current</label>
      </div>

      <div id="vote-skip" class="radio-button button-full button-gap">
        <input type="radio" name="action" id="vote-skip-radio" value="Skip" checked>
        <label for="vote-skip-radio">Skip</label>
      </div>

      <div id="skip-reason-container" style="margin-top: 1rem;">
        <label for="skip-reason" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
          Skip Reason <span style="color: #d00;">*</span>
        </label>
        <select
          name="skip_reason"
          id="skip-reason"
          required
          style="width: 100%; padding: 0.75rem; border: 1px solid #e4e4e4; border-radius: 4px; font-family: inherit; background: white;"
        >
          <option value="">Select a reason...</option>
          <option value="cannot_find">Cannot find project</option>
          <option value="conflict_of_interest">Conflict of interest</option>
          <option value="insufficient_info">Insufficient information</option>
          <option value="technical_issues">Technical issues</option>
          <option value="other">Other</option>
        </select>
      </div>

      <div style="margin-top: 1.5rem;">
        <label for="notes" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Notes (Optional)</label>
        <textarea
          name="notes"
          id="notes"
          rows="4"
          placeholder="Add any notes about the current project"
          style="width: 100%; padding: 0.75rem; border: 1px solid #e4e4e4; border-radius: 4px; font-family: inherit; resize: vertical;"
        ></textarea>
      </div>
      <input type="submit" name="action" value="Submit" id="vote-submit" class="button-full button-gap">
      <input type="hidden" name="prev_id" value="{{ prev.id }}">
      <input type="hidden" name="next_id" value="{{ next.id }}">
      <input type="hidden" name="_csrf_token" value="{{ csrf_token() }}">
    </form>
    <script src="{{ url_for('static', filename='js/timer.js') }}"></script>
    <script src="{{ url_for('static', filename='js/smart-button-toggle.js') }}"></script>
    <script src="{{ url_for('static', filename='js/info.js') }}"></script>

    <script>
      // Skip reason validation
      const skipReasonContainer = document.getElementById('skip-reason-container');
      const skipReasonSelect = document.getElementById('skip-reason');
      const skipRadio = document.getElementById('vote-skip-radio');
      const previousRadio = document.getElementById('vote-previous-radio');
      const currentRadio = document.getElementById('vote-current-radio');
      const form = document.querySelector('form');

      // Initially hide skip reason if not selecting skip
      function updateSkipReasonVisibility() {
        if (skipRadio.checked) {
          skipReasonContainer.style.display = 'block';
          skipReasonSelect.required = true;
        } else {
          skipReasonContainer.style.display = 'none';
          skipReasonSelect.required = false;
        }
      }

      // Listen for changes to action radio buttons
      skipRadio.addEventListener('change', updateSkipReasonVisibility);
      previousRadio.addEventListener('change', updateSkipReasonVisibility);
      currentRadio.addEventListener('change', updateSkipReasonVisibility);

      // Form validation
      form.addEventListener('submit', function(e) {
        if (skipRadio.checked && !skipReasonSelect.value) {
          e.preventDefault();
          alert('Please select a reason for skipping.');
          skipReasonSelect.focus();
          return false;
        }
      });

      // Initialize visibility
      updateSkipReasonVisibility();

      // Check if judging has been closed and smoothly transition to closed page
      async function checkClosedStatus() {
        try {
          const res = await fetch('/api/status');
          if (!res.ok) return;
          const data = await res.json();
          if (data.closed) {
            await showClosedPage();
          }
        } catch (err) {
          console.error("Error checking closed status:", err);
        }
      }

      async function showClosedPage() {
        try {
          const res = await fetch('/');
          if (!res.ok) return;
          const html = await res.text();

          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const newBody = doc.querySelector('body');

          if (newBody) {
            document.body.innerHTML = newBody.innerHTML;
            // Re-run any scripts in the new content
            const scripts = document.querySelectorAll('script');
            scripts.forEach(script => {
              if (script.textContent) {
                const newScript = document.createElement('script');
                newScript.textContent = script.textContent;
                script.parentNode.replaceChild(newScript, script);
              }
            });
          }
        } catch (err) {
          console.error("Error loading closed page:", err);
          window.location.reload();
        }
      }

      // Check every 5 seconds
      setInterval(checkClosedStatus, 5000);
    </script>
  </div>
</div>
{% endblock %}
