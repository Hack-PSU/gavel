{% extends "layout.html" %}
{% block title %}Closed{% endblock %}

{% block content %}
<div class="item">
  <div class="banner" id="closed-header">
    <h1>Judging Closed</h1>
    <p>Here are all projects and notes from all judges:</p>
  </div>

  <div id="projects-container">
    <p><i>Loading notes...</i></p>
  </div>
</div>

<script>
  let lastNotesData = null;

  async function fetchAllNotes() {
    try {
      const res = await fetch('/api/all_notes');
      if (!res.ok) throw new Error('Network error');
      const data = await res.json();

      // Only update if data has changed
      const dataString = JSON.stringify(data);
      if (lastNotesData === dataString) {
        return; // No changes, skip update
      }
      lastNotesData = dataString;

      const container = document.getElementById('projects-container');
      container.innerHTML = "";

      if (data.length === 0) {
        container.innerHTML = "<p><i>No notes available yet...</i></p>";
        return;
      }

      data.forEach(item => {
        const div = document.createElement('div');
        div.classList.add('project');
        div.style.marginBottom = '1.5rem';

        // Create h3 with XSS protection
        const h3 = document.createElement('h3');
        h3.textContent = item.project;

        // Create ul with XSS protection
        const ul = document.createElement('ul');
        item.notes.forEach(note => {
          const li = document.createElement('li');
          li.textContent = note;
          ul.appendChild(li);
        });

        div.appendChild(h3);
        div.appendChild(ul);
        container.appendChild(div);
      });
    } catch (err) {
      console.error('Error fetching notes:', err);
    }
  }

  async function checkReopenedStatus() {
    try {
      const res = await fetch('/api/status');
      if (!res.ok) return;
      const data = await res.json();
      if (!data.closed) {
        // Judging has been reopened, check for assignments
        await checkAssignmentStatus();
      }
    } catch (err) {
      console.error("Error checking reopened status:", err);
    }
  }

  async function checkAssignmentStatus() {
    try {
      const res = await fetch('/api/assignment_status');
      if (!res.ok) return;
      const data = await res.json();
      if (data.has_assignment) {
        // Smoothly transition to assignment page
        await showAssignmentPage();
      } else {
        // No assignment yet, show wait page
        await showWaitPage();
      }
    } catch (err) {
      console.error("Error checking assignment status:", err);
    }
  }

  async function showAssignmentPage() {
    try {
      const res = await fetch('/');
      if (!res.ok) return;
      const html = await res.text();

      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const newBody = doc.querySelector('body');

      if (newBody) {
        document.body.innerHTML = newBody.innerHTML;
        // Re-run any scripts in the new content
        const scripts = document.querySelectorAll('script');
        scripts.forEach(script => {
          if (script.textContent) {
            const newScript = document.createElement('script');
            newScript.textContent = script.textContent;
            script.parentNode.replaceChild(newScript, script);
          }
        });
      }
    } catch (err) {
      console.error("Error loading assignment page:", err);
      window.location.reload();
    }
  }

  async function showWaitPage() {
    try {
      const res = await fetch('/');
      if (!res.ok) return;
      const html = await res.text();

      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const newBody = doc.querySelector('body');

      if (newBody) {
        document.body.innerHTML = newBody.innerHTML;
        // Re-run any scripts in the new content
        const scripts = document.querySelectorAll('script');
        scripts.forEach(script => {
          if (script.textContent) {
            const newScript = document.createElement('script');
            newScript.textContent = script.textContent;
            script.parentNode.replaceChild(newScript, script);
          }
        });
      }
    } catch (err) {
      console.error("Error loading wait page:", err);
      window.location.reload();
    }
  }

  // Fetch immediately and auto-refresh every 5 seconds
  fetchAllNotes();
  checkReopenedStatus();  // Check immediately on page load

  setInterval(fetchAllNotes, 5000);         // every 5s for notes
  setInterval(checkReopenedStatus, 5000);   // every 5s to check if judging has been reopened
</script>
{% endblock %}
